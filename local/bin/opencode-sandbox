#!/bin/bash

set -euo pipefail

image=ghcr.io/anomalyco/opencode
io_root=/tmp/opencode-sandbox
terminal=""

if [ -t 0 ]; then
  terminal=-t
fi

# TODO: Would be nice to get away without deeply mounting auth.json
# tee -p ${io_root}.in | docker run \
exec docker run \
  -e OPENROUTER_API_KEY \
  -e OPENCODE_CONFIG=/opencode.jsonc \
  -e GIT_CONFIG_GLOBAL=/gitconfig \
  -w "$(pwd)" \
  -v "$(pwd):$(pwd)" \
  -v "$HOME/.gitconfig:/gitconfig:ro" \
  -v "${HOME}/.config/opencode/opencode-sandbox.jsonc:/opencode.jsonc" \
  -v "${HOME}/.local/share/opencode/auth.json:/root/.local/share/opencode/auth.json" \
  -i $terminal --rm ${image} \
  "$@"
#  "$@" | tee ${io_root}.out
#  acp
